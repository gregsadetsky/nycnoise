{% extends 'core/base.html' %}

{% block head %}
<script src="https://unpkg.com/maplibre-gl@^5.0.1/dist/maplibre-gl.js"></script>
<link href="https://unpkg.com/maplibre-gl@^5.0.1/dist/maplibre-gl.css" rel="stylesheet" />
<script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function() {
    const dateLinks = document.querySelectorAll('a[data-date]')
    dateLinks.forEach(link => {
      link.addEventListener('click', function(event) {
        event.preventDefault();
        
        const date = link.getAttribute('data-date');
        const mapDiv = document.querySelector(`#map-${date}`);
        const mapIsShown = mapDiv.style.display === 'block';
        mapDiv.style.display = mapIsShown ? 'none' : 'block';
        link.textContent = mapIsShown ? 'SHOW MAP' : 'HIDE MAP';

        // find all of the <div> with class="event"
        // that have a data-date of the same value,
        // and have a data-venue-latlng

        const eventDivs = document.querySelectorAll(`div.event[data-date="${date}"][data-venue-lnglat]`);

        const markers = Array.from(eventDivs).map(eventDiv => {
          const lnglat = eventDiv.getAttribute('data-venue-lnglat').split(',');
          return new window.maplibregl.Marker()
            .setLngLat(lnglat)
        });

        const map = new window.maplibregl.Map({
          container: `map-${date}`,
          zoom: 10,
          center: [-73.9, 40.72],
          style: "https://api.protomaps.com/styles/v4/light/en.json?key=744c0d83a2202e0c"
        });
        map.on('load', () => {
          markers.forEach(marker => marker.addTo(map));
          // map.fitBounds(markers.map(marker => marker.getLngLat()));
        });
      });
    })
  });
</script>
{% endblock head %}

{% block month_year_header %}
  {% if not is_index %}
    <h1>{{ month_year_header }}</h1>
  {% endif %}
{% endblock month_year_header %}

{% block content %}

  {% if index_page_messages and index_page_messages.pre_cal_msg %}
    <div id="pre-cal-msg">
      <p>{{ index_page_messages.pre_cal_msg|safe }}</p>
    </div>
  {% endif %}

  {% include "calendar/calendar.html" with calendar_dates=calendar_dates only %}

  {% if index_page_messages and index_page_messages.post_cal_msg %}
    <div id="post-cal-msg">
      <p>{{ index_page_messages.post_cal_msg|safe }}</p>
    </div>
  {% endif %}

  <div class="emailForm">
    <form method='POST' action="{% url 'email_subscribe' %}">
      {% csrf_token %}
      <input type='email' name='email' placeholder='you@somewhere.com' required>
      <input type='submit' value='subscribe'>
    </form>
  </div>

  {% for date in calendar_dates %}
    {% if date.is_current_page_month %}
      <article>
        <h4><a name="{{ date.date|date:'mdy' }}" href="/{{ date.date|date:'Y-m' }}/#{{ date.date|date:'mdy' }}">{{ date.date|date:"M d (D)"|lower }}</a></h4>

        <div class='maskYrSelf'>
          <a href="#" data-date="{{ date.date|date:'mdy' }}">SHOW MAP</a> â€¢
          MASK YR SELF!
        </div>

        <div id="map-{{ date.date|date:'mdy' }}" style="display:none; height: 300px;">map!
        </div>

        {% if date.date.date in date_messages %}
          {% for message in date_messages|get_item:date.date.date %}
            <div class='dateMessage'>{{ message|safe }}</div>
          {% endfor %}
        {% endif %}

        {% if date.date.date in all_events %}
          {% for event in all_events|get_item:date.date.date %}
            {% include "core/event.html" with event=event only %}

            {% comment %}
              {{ event.get_baked_html|safe }}
            {% endcomment %}
          {% endfor %}
        {% endif %}
        
      </article>
      <div class="goToTopLink">[<a href="#"><b>go to top</b></a>]</div>
    {% endif %}
  {% endfor %}
{% endblock content %}